name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    # Skip release commits to prevent infinite loop
    if: "!startsWith(github.event.head_commit.message, 'release:')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Read current version
        id: current
        run: |
          version=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Determine bump type
        id: bumptype
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "bump=${{ inputs.bump }}" >> "$GITHUB_OUTPUT"
          else
            # Auto-detect from commit messages since last tag
            last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$last_tag" ]; then
              commits=$(git log "${last_tag}..HEAD" --pretty=format:"%s")
            else
              commits=$(git log --pretty=format:"%s" -20)
            fi

            if echo "$commits" | grep -qiE '^(breaking|major)'; then
              echo "bump=major" >> "$GITHUB_OUTPUT"
            elif echo "$commits" | grep -qiE '^feat'; then
              echo "bump=minor" >> "$GITHUB_OUTPUT"
            else
              echo "bump=patch" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Bump version
        id: bump
        run: |
          current="${{ steps.current.outputs.version }}"
          IFS='.' read -ra parts <<< "$current"

          case "${{ steps.bumptype.outputs.bump }}" in
            major)
              parts[0]=$(( ${parts[0]} + 1 ))
              for i in $(seq 1 $(( ${#parts[@]} - 1 ))); do
                parts[$i]=0
              done
              ;;
            minor)
              parts[1]=$(( ${parts[1]} + 1 ))
              for i in $(seq 2 $(( ${#parts[@]} - 1 ))); do
                parts[$i]=0
              done
              ;;
            patch)
              last=$(( ${#parts[@]} - 1 ))
              parts[$last]=$(( ${parts[$last]} + 1 ))
              ;;
          esac

          new_version=$(IFS='.'; echo "${parts[*]}")
          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "Bumping $current -> $new_version (${{ steps.bumptype.outputs.bump }})"

      - name: Update gradle.properties
        run: |
          sed -i "s/^mod_version=.*/mod_version=${{ steps.bump.outputs.version }}/" gradle.properties

      - name: Extract changelog for this version
        id: changelog
        run: |
          version="${{ steps.bump.outputs.version }}"

          # Extract the Unreleased or matching version section
          changelog=$(awk -v ver="$version" '
            BEGIN { found=0; collecting=0 }
            /^## \[/ {
              if (collecting) exit
              if (index($0, "[" ver "]") || index($0, "[Unreleased]")) {
                found=1; collecting=1; next
              }
            }
            collecting { print }
          ' CHANGELOG.md)

          # If no entry found, generate from git log since last tag
          if [ -z "$changelog" ]; then
            echo "No changelog entry found, generating from commits..."
            last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$last_tag" ]; then
              commits=$(git log "${last_tag}..HEAD" --pretty=format:"- %s" --no-merges)
            else
              commits=$(git log --pretty=format:"- %s" --no-merges -20)
            fi
            changelog="### Changed
          ${commits}"
          fi

          echo "$changelog" > /tmp/changelog_body.txt
          echo "body_file=/tmp/changelog_body.txt" >> "$GITHUB_OUTPUT"

      - name: Update changelog with new version
        run: |
          version="${{ steps.bump.outputs.version }}"
          date=$(date +%Y-%m-%d)

          if grep -q '^\## \[Unreleased\]' CHANGELOG.md; then
            sed -i "s/^## \[Unreleased\]/## [$version] - $date/" CHANGELOG.md
          fi

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle.properties CHANGELOG.md
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "release: v${{ steps.bump.outputs.version }}"
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin HEAD --tags

      - name: Build
        run: ./gradlew build

      - name: Find built jar
        id: jar
        run: |
          jar=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
          echo "path=$jar" >> "$GITHUB_OUTPUT"
          echo "name=$(basename $jar)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.bump.outputs.version }}"
          name: "Scannable Reforged v${{ steps.bump.outputs.version }}"
          body_path: /tmp/changelog_body.txt
          files: ${{ steps.jar.outputs.path }}
          draft: false
          prerelease: false
